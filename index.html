<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PyleaMUN Data Organizer (Secure)</title>
    <style>
        /* All CSS styles remain the same, but I've added a few for the login area */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #E8EAE6; color: #333; }
        .letterhead { display: flex; justify-content: space-between; align-items: center; background-color: #D6DBD2; border-bottom: 2px solid #444; padding: 10px 20px; height: 100px; }
        .address, .contact { width: 25%; font-size: 0.9rem; }
        .contact { display: flex; flex-direction: column; align-items: flex-end; }
        .logo { width: 120px; height: auto; }
        .letterhead a { color: #0066cc; text-decoration: none; }
        main { padding: 2em; max-width: 1000px; margin: auto; }
        h1, h2 { text-align: center; color: #005b63; }
        .container { background: #e0f7fa; padding: 2em; border-radius: 16px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); }
        textarea { width: 100%; height: 150px; padding: 0.7em; border-radius: 8px; border: 1px solid #ccc; font-size: 1em; box-sizing: border-box; font-family: monospace; }
        .button-group { display: flex; justify-content: center; gap: 10px; margin: 1.5em 0; flex-wrap: wrap; }
        .btn { background-color: #00b4a0; color: white; font-size: 1em; padding: 0.8em 1.5em; border: none; border-radius: 50px; cursor: pointer; transition: all 0.3s ease; }
        .btn:hover { background-color: #00897b; transform: scale(1.05); }
        .btn.secondary { background-color: #00796b; }
        .btn.danger { background-color: #d32f2f; }
        .btn.danger:hover { background-color: #c62828; }
        #status { text-align: center; font-weight: bold; color: #004d40; margin-top: 1em; min-height: 24px; }
        #output { margin-top: 2em; background-color: #f1f8f8; padding: 1em 2em; border-radius: 8px; border: 1px solid #b2dfdb; }
        .output-group h3 { color: #00796b; border-bottom: 2px solid #b2dfdb; padding-bottom: 5px; }
        .output-group ul { list-style-type: none; padding-left: 0; }
        .output-group li { padding: 5px 0; }
        
        /* New styles for login section */
        #auth-container { text-align: center; padding: 20px; background-color: #cce5e2; border-radius: 8px; margin-bottom: 2em; }
        #user-info { font-weight: bold; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="letterhead"></div>

    <main>
        <h1>üèõÔ∏è PyleaMUN Delegations Organizer</h1>
        
        <div id="auth-container">
            <div id="user-info">Please sign in to manage data.</div>
            <div class="button-group">
                <button id="loginBtn" class="btn">Sign In with Google</button>
                <button id="logoutBtn" class="btn danger hidden">Sign Out</button>
            </div>
        </div>

        <div id="app-container" class="container hidden">
            <h2>Paste Form Submission Data Below</h2>
            <textarea id="rawDataInput" placeholder="Paste the raw text from the Formsubmit email here..."></textarea>
            <div class="button-group"><button id="processBtn" class="btn">Process Data</button></div>
            <div id="status"></div>
            <div id="controls" class="button-group" style="display: none;">
                <button class="btn secondary" onclick="displayByCommittee()">View by Committee</button>
                <button class="btn secondary" onclick="displayByCountry()">View by Country</button>
                <button class="btn secondary" onclick="displayBySchool()">View by School</button>
                <button class="btn secondary" onclick="exportToCsv()">Export All to CSV</button>
                <button class="btn danger" onclick="clearAllData()">Clear All Data</button>
            </div>
            <div id="output"></div>
        </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBeEVJ9eu-pVhK_z3ds8UurrqaBeBBDwN4",
            authDomain: "pyleamun-data.firebaseapp.com",
            databaseURL: "https://pyleamun-data-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "pyleamun-data",
            storageBucket: "pyleamun-data.appspot.com",
            messagingSenderId: "586095551075",
            appId: "1:586095551075:web:56d0e723275843d6dc4e56"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        const delegatesRef = database.ref('delegates');

        // --- GLOBAL STATE ---
        let allDelegates = [];

        // --- DOM ELEMENTS ---
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userInfo = document.getElementById('user-info');
        const appContainer = document.getElementById('app-container');

        // --- AUTHENTICATION LOGIC ---
        loginBtn.addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider);
        });

        logoutBtn.addEventListener('click', () => auth.signOut());

        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in
                userInfo.textContent = `Welcome, ${user.displayName}!`;
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                appContainer.classList.remove('hidden');
            } else {
                // User is signed out
                userInfo.textContent = 'Please sign in to manage data.';
                loginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                appContainer.classList.add('hidden');
            }
        });

        // --- REAL-TIME LISTENER & UI UPDATE ---
        delegatesRef.on('value', snapshot => {
            const data = snapshot.val();
            allDelegates = data ? Object.values(data) : [];
            updateUI();
        });

        function updateUI() {
            if (!auth.currentUser) return; // Don't update UI if logged out
            const statusEl = document.getElementById('status');
            const controlsEl = document.getElementById('controls');
            if (allDelegates.length > 0) {
                statusEl.textContent = `‚úÖ Synced with database. Total delegates: ${allDelegates.length}.`;
                controlsEl.style.display = 'flex';
            } else {
                statusEl.textContent = 'Database is empty. Paste a submission to get started.';
                controlsEl.style.display = 'none';
            }
        }
        
        // --- CORE & PARSING FUNCTIONS (REMAIN THE SAME) ---
        document.getElementById('processBtn').addEventListener('click', handleProcessData);
        // ... (The handleProcessData, clearAllData, parseRawData, structureDelegateData, display functions, etc. are all unchanged) ...
        function handleProcessData() { /* ... */ }
        function clearAllData() { /* ... */ }
        function parseRawData(rawText) { /* ... */ }
        function structureDelegateData(parsedData) { /* ... */ }
        function displayByCommittee() { /* ... */ }
        function displayByCountry() { /* ... */ }
        function displayBySchool() { /* ... */ }
        function groupBy(array, key) { /* ... */ }
        function exportToCsv() { /* ... */ }

        // --- CONSTANTS ---
        const FORM_FIELDS = ["School", "First Advisor‚Äôs personal e-mail", /* ... All other fields ... */];
        const COMMITTEE_MAP = {"UNEP": "UN Environment Programme üå±", /* ... All other committees ... */};

    </script>
</body>
</html>