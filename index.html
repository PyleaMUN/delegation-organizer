<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PyleaMUN Data Organizer</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #E8EAE6; color: #333; }
        .hidden { display: none !important; }
        .letterhead { display: flex; justify-content: space-between; align-items: center; background-color: #D6DBD2; border-bottom: 2px solid #444; padding: 10px 20px; min-height: 100px; flex-wrap: wrap; }
        .address, .contact { width: 30%; font-size: 0.9rem; }
        .contact { display: flex; flex-direction: column; align-items: flex-end; }
        .logo-container { width: 120px; text-align: center; }
        .logo { width: 120px; height: auto; }
        .letterhead a { color: #0066cc; text-decoration: none; }
        main { padding: 2em; max-width: 1000px; margin: auto; }
        h1, h2 { text-align: center; color: #005b63; }
        .container { background: #e0f7fa; padding: 2em; border-radius: 16px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); }
        textarea { width: 100%; height: 150px; padding: 0.7em; border-radius: 8px; border: 1px solid #ccc; font-size: 1em; box-sizing: border-box; font-family: monospace; }
        .button-group { display: flex; justify-content: center; gap: 10px; margin: 1.5em 0; flex-wrap: wrap; }
        .btn { background-color: #00b4a0; color: white; font-size: 1em; padding: 0.8em 1.5em; border: none; border-radius: 50px; cursor: pointer; transition: all 0.3s ease; }
        .btn:hover { background-color: #00897b; }
        .btn.secondary { background-color: #00796b; }
        .btn.danger { background-color: #d32f2f; }
        #status { text-align: center; font-weight: bold; color: #004d40; margin-top: 1em; min-height: 24px; }
        #output h3 { color: #00796b; border-bottom: 2px solid #b2dfdb; padding-bottom: 5px; }
        #output ul { list-style-type: none; padding-left: 0; }
        #output li { padding: 5px 0; }
        .advisor-info { background-color: #d0e8e6; border-radius: 8px; padding: 10px; margin: 5px 0 15px 0; font-size: 0.9em; }
    </style>
</head>
<body>

    <div id="app-container" class="hidden">
        <div class="letterhead">
            <div class="address"><strong>4 Isminis Str.</strong><br>Pylaia, Thessaloniki - 55535</div>
            <div class="logo-container"><img src="https://pyleamun.github.io/interview-guide/pyleaMUNfinallogo_transparent.png" alt="PyleaMUN Logo" class="logo"></div>
            <div class="contact">
                <div>üìû +30 2310329199</div>
                <div>üìß <a href="mailto:pyleamun@gmail.com">pyleamun@gmail.com</a></div>
                <div>üåê <a href="https://pyleamun.github.io/pyleamun2026/" target="_blank">pyleamun.github.io/pyleamun2026</a></div>
            </div>
        </div>
        <main>
            <h1>üèõÔ∏è PyleaMUN Delegations Organizer</h1>
            <div class="container">
                <h2>Paste Form Submission Data Below</h2>
                <textarea id="rawDataInput" placeholder="Paste the raw text from the Formsubmit email here..."></textarea>
                <div class="button-group"><button id="processBtn" class="btn">Process Data</button></div>
                <div id="status"></div>
                <div id="controls" class="button-group" style="display: none;">
                    <button class="btn secondary" onclick="displayByCommittee()">View by Committee</button>
                    <button class="btn secondary" onclick="displayByCountry()">View by Country</button>
                    <button class="btn secondary" onclick="displayBySchool()">View by School</button>
                    <button class="btn secondary" onclick="exportToCsv()">Export All to CSV</button>
                    <button class="btn danger" onclick="clearAllData()">Clear All Data</button>
                </div>
                <div id="output"></div>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // --- PASSWORDS ---
        const SHARED_PASSWORD = "thess26@"; 
        const CLEAR_DATA_PASSWORD = "panos26@";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBeEVJ9eu-pVhK_z3ds8UurrqaBeBBDwN4",
            authDomain: "pyleamun-data.firebaseapp.com",
            databaseURL: "https://pyleamun-data-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "pyleamun-data",
            storageBucket: "pyleamun-data.appspot.com",
            messagingSenderId: "586095551075",
            appId: "1:586095551075:web:56d0e723275843d6dc4e56"
        };

        // --- INITIALIZATION ---
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const delegatesRef = database.ref('delegates');
        let allDelegates = [];

        function checkPassword() {
            const storedPassword = sessionStorage.getItem('pyleamun-auth');
            if (storedPassword === SHARED_PASSWORD) {
                initializeApp();
                return;
            }
            const enteredPassword = prompt("Please enter the organizer password:", "");
            if (enteredPassword === SHARED_PASSWORD) {
                sessionStorage.setItem('pyleamun-auth', enteredPassword);
                initializeApp();
            } else if (enteredPassword) {
                alert("Incorrect password.");
            }
        }

        function initializeApp() {
            document.getElementById('app-container').classList.remove('hidden');
            delegatesRef.on('value', snapshot => {
                const data = snapshot.val();
                allDelegates = data ? Object.values(data) : [];
                updateUI();
            });
        }
        
        function updateUI() {
            const controlsEl = document.getElementById('controls');
            document.getElementById('status').textContent = `Total delegates in database: ${allDelegates.length}.`;
            controlsEl.style.display = allDelegates.length > 0 ? 'flex' : 'none';
        }
        
        // --- EVENT LISTENERS ---
        document.getElementById('processBtn').addEventListener('click', handleProcessData);
        
        // --- DATA & DISPLAY FUNCTIONS ---
        function handleProcessData() {
            const rawDataInput = document.getElementById('rawDataInput');
            if (!rawDataInput.value.trim()) {
                document.getElementById('status').textContent = "‚ö†Ô∏è Please paste data into the text box.";
                return;
            }
            const parsedData = parseRawData(rawDataInput.value);
            if (parsedData) {
                const newDelegates = structureDelegateData(parsedData);
                newDelegates.forEach(delegate => { delegatesRef.push(delegate); });
                document.getElementById('status').textContent = `‚úÖ Added ${newDelegates.length} delegates for "${parsedData.School || 'Unknown School'}" to the database.`;
                rawDataInput.value = '';
                document.getElementById('output').innerHTML = '';
            } else {
                document.getElementById('status').textContent = "‚ùå Error: Could not parse the data. Please check the format.";
            }
        }

        function clearAllData() {
            const enteredPassword = prompt("This is a destructive action. Please enter the admin password to clear all data:", "");
            if (enteredPassword === CLEAR_DATA_PASSWORD) {
                if (confirm("FINAL CONFIRMATION: Are you sure you want to permanently delete ALL delegate data?")) {
                    delegatesRef.remove();
                }
            } else if (enteredPassword) {
                alert("Incorrect password. Data was not cleared.");
            }
        }
        
        function structureDelegateData(parsedData) {
            const delegates = [];
            const schoolInfo = {
                school: parsedData["School"] || "N/A",
                advisor1_email: parsedData["First Advisor‚Äôs personal e-mail"] || "",
                advisor1_mobile: parsedData["First Advisor‚Äôs mobile number"] || "",
                advisor2_email: parsedData["Second Advisor‚Äôs personal e-mail"] || "",
                advisor2_mobile: parsedData["Second Advisor‚Äôs mobile number"] || ""
            };
            const country1Name = parsedData["Country 1"] || "N/A";
            const country2Name = parsedData["Country 2"] || "N/A";
            const COMMITTEE_MAP = {"UNEP": "UN Environment Programme üå±", "SC": "Security Council üîê", "ECOSOC": "Economic & Social Council üí∞", "NATO": "NATO üõ°Ô∏è", "WHO": "World Health Organisation üè•", "HRC": "Human Rights Council ü§ù", "UNESCO": "UNESCO üìö", "UN Women": "UN Women üë©‚Äç‚öñÔ∏è", "HCC": "Historical Crisis Committee ‚è≥"};

            for (const key in parsedData) {
                const delegateName = parsedData[key];
                if (delegateName && key.includes("Country") && !["Country 1", "Country 2"].includes(key)) {
                    const parts = key.split(" ");
                    const committeeShort = parts[0];
                    const countryNum = parts[2];
                    
                    delegates.push({
                        name: delegateName,
                        school: schoolInfo.school,
                        committee: COMMITTEE_MAP[committeeShort] || committeeShort,
                        country: countryNum === "1" ? country1Name : country2Name,
                        advisor1_email: schoolInfo.advisor1_email,
                        advisor1_mobile: schoolInfo.advisor1_mobile,
                        advisor2_email: schoolInfo.advisor2_email,
                        advisor2_mobile: schoolInfo.advisor2_mobile,
                    });
                }
            }
            return delegates;
        }

        function displayBySchool() {
            const grouped = groupBy(allDelegates, 'school');
            let html = '<h2>üè´ Delegates by School</h2>';
            for (const school of Object.keys(grouped).sort()) {
                const schoolDelegates = grouped[school];
                const firstDelegate = schoolDelegates[0];
                
                html += `<h3>${school}</h3>`;
                html += `<div class="advisor-info">`;
                if (firstDelegate.advisor1_email || firstDelegate.advisor1_mobile) {
                    html += `<strong>Advisor 1:</strong> ${firstDelegate.advisor1_email || 'No Email'} | ${firstDelegate.advisor1_mobile || 'No Mobile'}<br>`;
                }
                if (firstDelegate.advisor2_email || firstDelegate.advisor2_mobile) {
                    html += `<strong>Advisor 2:</strong> ${firstDelegate.advisor2_email || 'No Email'} | ${firstDelegate.advisor2_mobile || 'No Mobile'}`;
                }
                html += `</div><ul>`;
                
                schoolDelegates.sort((a, b) => a.name.localeCompare(b.name)).forEach(d => {
                    html += `<li><b>${d.name}</b> - Committee: ${d.committee} (${d.country})</li>`;
                });
                html += '</ul>';
            }
            document.getElementById('output').innerHTML = html;
        }

        function exportToCsv() {
            if (allDelegates.length === 0) { alert("No data to export."); return; }
            const headers = ['name', 'school', 'committee', 'country', 'advisor1_email', 'advisor1_mobile', 'advisor2_email', 'advisor2_mobile'];
            let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n";
            allDelegates.forEach(delegate => {
                const row = headers.map(header => `"${(delegate[header] || "").replace(/"/g, '""')}"`);
                csvContent += row.join(",") + "\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "pyleamun_registrations.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- HELPER FUNCTIONS (UNCHANGED) ---
        function parseRawData(rawText) {
            let cleanedText = rawText.replace(/‚Äôs_/g, "‚Äôs ").replace(/_/g, " ");
            if (cleanedText.includes("Here's what they had to say:")) { cleanedText = cleanedText.split("Here's what they had to say:")[1]; }
            if (cleanedText.includes("Submitted at")) { cleanedText = cleanedText.split("Submitted at")[0]; }
            cleanedText = cleanedText.trim();
            const FORM_FIELDS = ["School", "First Advisor‚Äôs personal e-mail", "First Advisor‚Äôs mobile number", "Second Advisor‚Äôs personal e-mail", "Second Advisor‚Äôs mobile number", "Number of Delegates", "Country 1", "Country 2", "UNEP Country 1", "UNEP Country 2", "SC Country 1", "SC Country 2", "ECOSOC Country 1", "ECOSOC Country 2", "NATO Country 1", "NATO Country 2", "WHO Country 1", "WHO Country 2", "HRC Country 1", "HRC Country 2", "UNESCO Country 1", "UNESCO Country 2", "UN Women Country 1", "UN Women Country 2", "HCC Country 1", "HCC Country 2", "Special Comments"];
            const foundFields = [];
            FORM_FIELDS.forEach(field => {
                let pos = cleanedText.indexOf(field);
                if (pos !== -1) { foundFields.push({ field, pos }); }
            });
            if (foundFields.length === 0) return null;
            foundFields.sort((a, b) => a.pos - b.pos);
            const parsedData = {};
            for (let i = 0; i < foundFields.length; i++) {
                const currentField = foundFields[i];
                const nextField = foundFields[i + 1];
                const startOfValue = currentField.pos + currentField.field.length;
                const endOfValue = nextField ? nextField.pos : cleanedText.length;
                const value = cleanedText.substring(startOfValue, endOfValue).trim();
                parsedData[currentField.field] = value;
            }
            return parsedData;
        }
        function displayByCommittee() {
            const grouped = groupBy(allDelegates, 'committee');
            let html = '<h2>üìã Delegates by Committee</h2>';
            for (const committee of Object.keys(grouped).sort()) {
                html += `<h3>${committee}</h3><ul>`;
                grouped[committee].sort((a, b) => a.name.localeCompare(b.name)).forEach(d => { html += `<li><b>${d.name}</b> (${d.school}) - Representing: ${d.country}</li>`; });
                html += '</ul>';
            }
            document.getElementById('output').innerHTML = html;
        }
        function displayByCountry() {
            const grouped = groupBy(allDelegates, 'country');
            let html = '<h2>üåç Delegates by Country</h2>';
            for (const country of Object.keys(grouped).sort()) {
                html += `<h3>üá∫üá≥ ${country}</h3><ul>`;
                grouped[country].sort((a, b) => a.name.localeCompare(b.name)).forEach(d => { html += `<li><b>${d.name}</b> (${d.school}) - Committee: ${d.committee}</li>`; });
                html += '</ul>';
            }
            document.getElementById('output').innerHTML = html;
        }
        function groupBy(array, key) {
            return array.reduce((result, currentValue) => {
                (result[currentValue[key]] = result[currentValue[key]] || []).push(currentValue);
                return result;
            }, {});
        }

        // --- START THE APP ---
        checkPassword();
    </script>
</body>
</html>